<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/result.css}">
  <title>Question Builder</title>
  <style>
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #28a745;
      color: #fff;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>

<body>
<div th:insert="~{navbar.html :: navbar}"></div>
<h1>Question Builder</h1>

<div class="container py-3">
  <div class="input-group mb-3">
    <input type="text" class="form-control" id="searchId" placeholder="Enter Question ID" aria-label="Enter Question ID">
    <button class="btn btn-primary" onclick="fetchQuestionById()">Get Answer</button>
  </div>
</div>

<div class="container py-5">
  <h1>Create a New Java Quiz Question</h1>
  <form id="questionForm">
    <div class="mb-3">
      <label for="questionType" class="form-label">Question Type</label>
      <select class="form-select" id="questionType" name="questionType">
        <option value="CODE">Code</option>
        <option value="SIMPLE">Text</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="questionHeader" class="form-label">Question Header</label>
      <input type="text" class="form-control" id="questionHeader" name="questionHeader" required>
    </div>
    <div class="mb-3">
      <label for="questionText" class="form-label">Question Text</label>
      <textarea class="form-control" id="questionText" name="questionText" rows="5" required></textarea>
    </div>
    <div class="mb-3">
      <label for="difficultyLevel" class="form-label">Difficulty Level</label>
      <input type="number" class="form-control" id="difficultyLevel" name="difficultyLevel" min="1" max="5" required>
    </div>
    <div class="mb-3">
      <label for="points" class="form-label">Points</label>
      <input type="number" class="form-control" id="points" name="points" min="1" required>
    </div>
    <div class="mb-3">
      <label for="correctAnswer" class="form-label">Correct Answer</label>
      <input type="text" class="form-control" id="correctAnswer" name="correctAnswer" required>
    </div>
    <div class="mb-3">
      <label for="correctAnswerExplanation" class="form-label">Explanation for the Correct Answer</label>
      <textarea class="form-control" id="correctAnswerExplanation" name="correctAnswerExplanation" rows="3"></textarea>
    </div>
    <div class="mb-3">
      <label for="choices" class="form-label">Answer Choices (comma-separated)</label>
      <input type="text" class="form-control" id="choices" name="choices" required>
    </div>

    <!-- Dynamic Button -->
    <button type="button" class="btn btn-success" id="actionButton" onclick="submitForm()">Create Question</button>
  </form>
</div>

<div id="notification" class="notification" style="display: none;" onclick="hideNotification()">
  Question added successfully!
</div>

<script>
  let currentQuestionId = null;

  function submitForm() {
      if (currentQuestionId) {
          updateQuestion(currentQuestionId);
      } else {
          createQuestion();
      }
  }

  function createQuestion() {
      const formData = collectFormData();
      fetch('/api/v1/exam/addQuestion', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => showNotification("Question added successfully!"))
      .catch(error => showNotification("Failed to add question."))
      .finally(() => resetPage());
  }

  function updateQuestion(id) {
      const formData = collectFormData();
      fetch(`/api/v1/exam/update-question/${id}`, {
          method: 'PUT',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => showNotification("Question updated successfully!"))
      .catch(error => showNotification("Failed to update question."))
      .finally(() => resetPage());
  }

  function fetchQuestionById() {
      const questionId = document.getElementById('searchId').value;
      if (!questionId) {
          showNotification("Please enter a valid Question ID.");
          return;
      }

      fetch(`/api/v1/exam/question/${questionId}`)
          .then(response => {
              if (!response.ok) throw new Error("Question not found.");
              return response.json();
          })
          .then(data => {
              populateForm(data);
              currentQuestionId = questionId;
              document.getElementById('actionButton').textContent = "Update Question";
          })
          .catch(error => showNotification("Failed to fetch question."));
  }

  function populateForm(data) {
      document.getElementById('questionType').value = data.questionType;
      document.getElementById('questionHeader').value = data.questionHeader;
      document.getElementById('questionText').value = data.questionText;
      document.getElementById('difficultyLevel').value = data.difficultyLevel;
      document.getElementById('points').value = data.points;
      document.getElementById('correctAnswer').value = data.correctAnswer;
      document.getElementById('correctAnswerExplanation').value = data.correctAnswerExplanation;
      document.getElementById('choices').value = data.choices.join(',');
  }

  function collectFormData() {
      return {
          questionType: document.getElementById('questionType').value,
          questionHeader: document.getElementById('questionHeader').value,
          questionText: document.getElementById('questionText').value,
          difficultyLevel: document.getElementById('difficultyLevel').value,
          points: document.getElementById('points').value,
          correctAnswer: document.getElementById('correctAnswer').value,
          correctAnswerExplanation: document.getElementById('correctAnswerExplanation').value,
          choices: document.getElementById('choices').value.split(',')
      };
  }

  function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => notification.style.display = 'none', 5000);
  }

  function hideNotification() {
      document.getElementById('notification').style.display = 'none';
  }

  function resetPage() {
      currentQuestionId = null;
      document.getElementById('questionForm').reset();
      document.getElementById('actionButton').textContent = "Create Question";
      setTimeout(() => window.location.reload(), 500);  // Reload the page to reset state
  }
</script>

<div th:insert="~{footer.html :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>